import { Job, Worker } from "bullmq";
import { bot } from ".";
import { Thread } from "../entity/assistants/Thread";
import { Action } from "../entity/assistants/Action";
import { AppDataSource } from "../data-source";
import pino from "pino";
import { User } from "../entity/User";
import { Router } from "./router";
import { MessageFormatter } from "../utils/MessageFormatter";
const logger = pino();

interface IJob {
  type: "neuro";
  task: string;
  userId: string;
  actionId: string;
}

interface IJobCreate extends IJob {
  task: "create";
  threadId: string;
}

interface IJobRun extends IJob {
  task: "run";
  messages: string[];
  tokenCount: number;
  msgId: string;
}

interface IJobDelete extends IJob {
  task: "delete";
  sendResetMessage: boolean;
}

interface IJobImage extends IJob {
  task: "image";
  imageUrl: string;
  msgId: string;
}

interface IJobVoice extends IJob {
  task: "voice";
  text: string;
  msgId: string;
  result: string;
}


let agreementsMap = new Map<string, string>();
agreementsMap.set(
  "–î–æ–≥–æ–≤–æ—Ä –æ —Å–æ–∑–¥–∞–Ω–∏–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞\n",
  "offers-1",
);
agreementsMap.set(
  "–î–æ–≥–æ–≤–æ—Ä –æ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n",
  "offers-2",
);
agreementsMap.set( "–î–æ–≥–æ–≤–æ—Ä –∑–∞–π–º–∞\n","offers-3",);
agreementsMap.set( "–î–æ–≥–æ–≤–æ—Ä –∞–≤—Ç–æ—Ä—Å–∫–æ–≥–æ –∑–∞–∫–∞–∑–∞\n", "offers-4",);
agreementsMap.set( "–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏ –ø—Ä–æ–¥–∞–∂–∏\n", "offers-5",);
agreementsMap.set( "–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥\n", "offers-7",);
agreementsMap.set( "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä\n", "offers-6",);
agreementsMap.set("–î–æ–≥–æ–≤–æ—Ä –æ—Ñ–µ—Ä—Ç—ã\n", "offers-8");



/**
 * This class is a single worker that processes back openai requests
 */
export class Handler {
  worker: Worker;

  /**
   * This creates a new Worker on the neuro back queue that processes incoming OpenAI queue requests
   */
  constructor() {
    this.worker = new Worker(
      "neuro",
      async (
        job: Job<IJobCreate | IJobRun | IJobDelete | IJobImage | IJobVoice>,
      ) => {
        try {
          const manager = AppDataSource.manager;
          const j = job.data;
          const act = await manager.findOne(Action, {
            where: {
              id: j.actionId,
            },
          });
          if (j.task === "create") {
            const thread = new Thread();
            thread.actionId = j.actionId;
            thread.userId = j.userId;
            thread.id = j.threadId;
            await manager.save(thread);
            const u = await manager.findOneBy(User, {
              chatId: String(j.userId),
            });
            if (!u) return;
            switch (u.actionId) {
              case "asst_14B08GDgJphVClkmmtQYo0aq":
                await bot.sendMessage(
                  +thread.userId,
                  "–û—Ç–ª–∏—á–Ω–æ, —Å —Ä–∞–∑–º–µ—Ä–æ–º –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏—Å—å. –¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–º–ø–∞–Ω–∏–∏.",
                );
                break;
              case "asst_WHhZd8u8rXpAHADdjIwBM9CJ":
                await bot.sendMessage(+j.userId, "–î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –º–Ω–µ –Ω—É–∂–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:")
                await MessageFormatter.sendTextFromFileBot(bot, agreementsMap.get(u.agreementType)! + ".txt", +u.chatId);
                break;
              case "asst_1BdIGF3mp94XvVfgS88fLIor":
                await bot.sendMessage(
                  +thread.userId,
                  `${u.textStyle ?? "–°—Ç–∏–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω"}\n${u.textTone ?? "–¢–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω"}\n–û—Ç–ª–∏—á–Ω–æ, —Å–æ —Å—Ç–∏–ª–µ–º –∏ —Ç–æ–Ω–æ–º –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏—Å—å! üòâ
–¢–µ–ø–µ—Ä—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫–ª–∞–¥–∞ –º–Ω–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç —Ç–µ–±—è –≤–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
1)–¢–µ–º–∞ 
2)–î–ª—è –∫–æ–≥–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç  (—Å—Ç—É–¥–µ–Ω—Ç—ã, –∏–Ω–≤–µ—Å—Ç–æ—Ä—ã‚Ä¶)
3)–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (5 –º–∏–Ω; 10 –º–∏–Ω; 30 –º–∏–Ω)

–û—Ç–≤–µ—Ç –ø—Ä–∏—à–ª–∏ –º–Ω–µ –≤ –æ—Ç–≤–µ—Ç–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏!

–û–∂–∏–¥–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)üòâ`,
                );
                break;
              default:
                await bot.sendMessage(+thread.userId, act!.welcomeMessage);
                break;
            }

            await bot.sendMessage(+thread.userId, "–ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:", {
              reply_markup: {
                inline_keyboard: [
                  [
                    {
                      text: `${u.model === "gpt-4o-mini" ? "‚úÖ" : ""} GPT 4 Omni mini`,
                      callback_data: "aimodel-gpt-4o-mini",
                    },
                  ],
                  [
                    {
                      text: `${u.model === "gpt-4o" ? "‚úÖ" : ""} GPT 4 Omni`,
                      callback_data: "aimodel-gpt-4o",
                    },
                  ],
                  [
                    {
                      text: `${u.model === "gpt-4-turbo" ? "‚úÖ" : ""} GPT 4 Turbo`,
                      callback_data: "aimodel-gpt-4-turbo",
                    },
                  ],
                ],
              },
            });
          } else if (j.task === "delete") {
            if (j.sendResetMessage) {
              await bot.sendMessage(
                +j.userId,
                "–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω! –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥",
              );
            }
          } else if (j.task === "run") {
            const user = await manager.findOneBy(User, {
              chatId: j.userId,
            });
            if (!user) throw new Error("User not found");
            const cost =
              (j.tokenCount / 1000000) *
              (user.model === "gpt-4o-mini"
                ? 0.6
                : user.model === "gpt-4o"
                  ? 10
                  : 30) *
              100;
            if (user.leftForToday > 0) {
              logger.info("Case 1");
              user.leftForToday -= cost;
              user.leftForToday = Math.max(0, user.leftForToday);
            } else if (user.addBalance > 0) {
              logger.info("Case 2");
              user.addBalance -= cost;
              user.addBalance = Math.max(0, user.addBalance);
            }
            await manager.save(user);

            for (const m of j.messages) {
              if (act?.format === "text") {
                await bot.sendMessage(+j.userId, m, {});
              } else if (act?.format === "html-file") {
                const b = Buffer.from(m, "utf-8");
                await Router.tryDeletePrevious(+j.msgId + 2, +j.userId);
                await bot.sendDocument(
                  +j.userId,
                  b,
                  {
                    caption: "–í–∞—à –æ—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –µ—â–µ - –ø–∏—à–∏—Ç–µ.",
                  },
                  {
                    contentType: "text/html",
                    filename: "report.html",
                  },
                );
              }
            }
            if (user.countTokens) {
              await bot.sendMessage(
                +user.chatId,
                `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤: ${Math.round((cost / 34) * 10000)}`,
              );
            }
          } else if (j.task === "image") {
            await Router.tryDeletePrevious(+j.msgId + 2, +j.userId);
            await bot.sendPhoto(+j.userId, j.imageUrl, {
              caption: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
              reply_markup: {
                inline_keyboard: [
                  [
                    {
                      text: "1024x1024",
                      callback_data: "res-1024x1024",
                    },
                  ],
                  [
                    {
                      text: "1024x1792",
                      callback_data: "res-1024x1792",
                    },
                  ],
                  [
                    {
                      text: "1792x1024",
                      callback_data: "res-1792x1024",
                    },
                  ],
                  [
                    {
                      text: "–ó–∞–∫–æ–Ω—á–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é",
                      callback_data: "stop-images",
                    },
                  ],
                ],
              },
            });
          } else if (j.task === "voice") {
            await bot.sendMessage(+j.userId, j.result);
          }
        } catch (err) {
          logger.fatal(err);
        }
      },
      {
        connection: {
          host: "redis",
        },
      },
    );
  }
}
